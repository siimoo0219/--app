<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»•æœ¨æœ‰é™å…¬å¸</title>
    <style>
        /* CSS æ¨£å¼ç¶­æŒä¸è®Šï¼Œä¿æŒç¾è§€ */
        :root { --primary: #2563eb; --finance: #10b981; --expense: #ef4444; --bg: #f3f4f6; --card: #ffffff; --text: #1f2937; --border: #e5e7eb; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); padding-bottom: 80px; }
        .header { background: var(--card); padding: 15px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; text-align: center; font-weight: bold; font-size: 1.1rem; color: var(--primary); }
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-group { margin-bottom: 18px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.95rem; color: #4b5563; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background: #fff; outline: none; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); }
        .btn-group { display: flex; gap: 10px; }
        .btn-option { flex: 1; padding: 12px; border: 1px solid var(--border); background: white; border-radius: 8px; text-align: center; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-option.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3); }
        .finance-toggle { display: flex; background: #e5e7eb; border-radius: 10px; padding: 4px; margin-bottom: 20px; }
        .toggle-item { flex: 1; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; font-weight: bold; color: #6b7280; }
        .toggle-item.active-in { background: white; color: var(--finance); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .toggle-item.active-out { background: white; color: var(--expense); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .submit-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2); }
        .submit-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; border-top: 1px solid var(--border); padding-bottom: env(safe-area-inset-bottom); z-index: 100; }
        .nav-item { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #9ca3af; font-size: 0.8rem; }
        .nav-item div { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); }
        .page { display: none; }
        .page.active { display: block; }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ”„</div>
        <div>æ­£åœ¨å¾ Google Sheets åŒæ­¥è³‡æ–™...</div>
    </div>

    <div class="header" id="header-title">RenovatePro å¸«å‚…å›å ±</div>

    <div id="page-worker" class="page active">
        <div class="container">
            <div class="card">
                <div class="form-group">
                    <label>ğŸ“… æ—¥æœŸ</label>
                    <input type="date" id="w-date">
                </div>
                <div class="form-group">
                    <label>ğŸ‘·â€â™‚ï¸ å“¡å·¥å§“å</label>
                    <select id="w-name"><option>è¼‰å…¥ä¸­...</option></select>
                </div>
                <div class="form-group">
                    <label>ğŸ—ï¸ å°ˆæ¡ˆå·¥åœ°</label>
                    <select id="w-project"><option>è¼‰å…¥ä¸­...</option></select>
                </div>
                <div class="form-group">
                    <label>ğŸ“ å·¥ä½œå…§å®¹</label>
                    <textarea id="w-desc" rows="3" placeholder="ä¾‹å¦‚ï¼šé‡˜å¤©èŠ±æ¿éª¨æ¶..."></textarea>
                </div>
            </div>

            <div class="card">
                <div class="form-group">
                    <label>â° ä»Šæ—¥å·¥æ•¸</label>
                    <div class="btn-group" id="work-unit-group">
                        <div class="btn-option active" data-val="1">1 å·¥</div>
                        <div class="btn-option" data-val="0.5">0.5 å·¥</div>
                        <div class="btn-option" data-val="0">0</div>
                    </div>
                    <input type="hidden" id="w-unit" value="1">
                </div>
                <div class="form-group">
                    <label>ğŸŒ™ åŠ ç­æ™‚æ•¸ (hr)</label>
                    <input type="number" id="w-overtime" value="0" min="0" step="0.5">
                </div>
            </div>

            <div class="card" style="border-left: 5px solid #f59e0b;">
                <div class="form-group">
                    <label style="color:#d97706;">ğŸ’° ä»£å¢Šè²»ç”¨ (ç„¡å‰‡å…å¡«)</label>
                    <input type="number" id="w-claim" placeholder="è¼¸å…¥é‡‘é¡">
                </div>
                <div class="form-group">
                    <label>ä»£å¢Šèªªæ˜</label>
                    <input type="text" id="w-claim-desc" placeholder="ä¾‹å¦‚ï¼šè²·æ¶¼æ°´">
                </div>
            </div>
            <button type="button" class="submit-btn" onclick="sendWorkerData()">ğŸš€ é€å‡ºå·¥æ™‚</button>
        </div>
    </div>

    <div id="page-finance" class="page">
        <div class="container">
            <div class="card">
                <div class="finance-toggle">
                    <div class="toggle-item active-out" id="btn-expense" onclick="setFinanceType('out')">æ”¯å‡º</div>
                    <div class="toggle-item" id="btn-income" onclick="setFinanceType('in')">æ”¶å…¥</div>
                </div>
                <input type="hidden" id="f-type" value="æ”¯å‡º">

                <div class="form-group">
                    <label>ğŸ“… æ—¥æœŸ</label>
                    <input type="date" id="f-date">
                </div>
                <div class="form-group">
                    <label>ğŸ—ï¸ å°ˆæ¡ˆå·¥åœ°</label>
                    <select id="f-project"></select>
                </div>
                <div class="form-group">
                    <label>ğŸ“‚ åˆ†é¡</label>
                    <select id="f-category"><option>è¼‰å…¥ä¸­...</option></select>
                </div>
                <div class="form-group" id="vendor-group">
                    <label>ğŸ¢ å» å•† / å°è±¡</label>
                    <input type="text" id="f-vendor" placeholder="ä¾‹å¦‚ï¼šæ°¸èª å»ºæ">
                </div>
                <div class="form-group">
                    <label>ğŸ“ ç´°é …èªªæ˜</label>
                    <input type="text" id="f-desc" placeholder="ä¾‹å¦‚ï¼šçŸ½é…¸éˆ£æ¿ 20ç‰‡">
                </div>
                <div class="form-group">
                    <label>ğŸ’° é‡‘é¡</label>
                    <input type="number" id="f-amount" placeholder="è¼¸å…¥é‡‘é¡" style="font-size:1.2rem; font-weight:bold;">
                </div>
            </div>
            <button type="button" class="submit-btn" style="background-color: var(--expense);" id="f-submit-btn" onclick="sendFinanceData()">ğŸ’¸ ç¢ºèªæ”¯å‡º</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('worker', this)" id="nav-worker">
            <div>ğŸ‘·</div> å·¥æ™‚å›å ±
        </div>
        <div class="nav-item" onclick="switchPage('finance', this)" id="nav-finance">
            <div>ğŸ’¸</div> æ”¶æ”¯è¨˜å¸³
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ è«‹åœ¨é€™è£¡è²¼ä¸Š Apps Script ç¶²å€
        // ==========================================
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbylBF3jiDIw2TnUOXOBt_j54HMTm03-jgV1fhv6Qz6wzz84zoGmm9hjLrli1w_cLBSTpg/exec"; 


        // --- åˆå§‹åŒ–ï¼šè¼‰å…¥ Google Sheets æ¸…å–® ---
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('w-date').value = today;
            document.getElementById('f-date').value = today;
            
            // åŸ·è¡Œè³‡æ–™åŒæ­¥
            fetchDataFromGoogle();
        };

        // é€™æ˜¯æ–°çš„æ ¸å¿ƒåŠŸèƒ½ï¼šå»å¾Œå°æŠ“è³‡æ–™
        function fetchDataFromGoogle() {
            fetch(SCRIPT_URL)
                .then(response => response.json())
                .then(data => {
                    // å¡«å…¥é¸å–®
                    populateSelect('w-name', data.employees);
                    populateSelect('w-project', data.projects);
                    
                    // è¨˜å¸³é é¢çš„å°ˆæ¡ˆé¸å–®ä¹Ÿè¦å¡«
                    populateSelect('f-project', data.projects);
                    
                    // å¡«å…¥æ”¶æ”¯åˆ†é¡
                    populateSelect('f-category', data.categories);

                    // éš±è—è¼‰å…¥ç•«é¢
                    document.getElementById('loading-overlay').style.display = 'none';
                })
                .catch(error => {
                    alert("âŒ ç„¡æ³•åŒæ­¥ Google Sheets è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€ã€‚\n" + error);
                    document.getElementById('loading-overlay').style.display = 'none';
                });
        }

        function populateSelect(id, list) {
            const select = document.getElementById(id);
            select.innerHTML = ""; // æ¸…ç©ºåŸæœ¬çš„ã€Œè¼‰å…¥ä¸­...ã€
            if(list && list.length > 0) {
                list.forEach(item => select.add(new Option(item, item)));
            } else {
                select.add(new Option("ç„¡è³‡æ–™", ""));
            }
        }

        // --- å·¥æ™‚å›å ± ---
        function sendWorkerData() {
            const btn = document.querySelector('#page-worker .submit-btn');
            const desc = document.getElementById('w-desc').value;
            if(!desc) { alert("è«‹å¡«å¯«å·¥ä½œå…§å®¹ï¼"); return; }

            const data = {
                date: document.getElementById('w-date').value,
                name: document.getElementById('w-name').value,
                project: document.getElementById('w-project').value,
                desc: desc,
                unit: document.getElementById('w-unit').value,
                overtime: document.getElementById('w-overtime').value || 0,
                claim: document.getElementById('w-claim').value || 0,
                claimDesc: document.getElementById('w-claim-desc').value || ""
            };

            submitToGoogle('worker', data, btn);
        }

        // --- è¨˜å¸³å›å ± ---
        function sendFinanceData() {
            const btn = document.querySelector('#page-finance .submit-btn');
            const amount = document.getElementById('f-amount').value;
            if(!amount) { alert("è«‹è¼¸å…¥é‡‘é¡"); return; }
            const type = document.getElementById('f-type').value;
            const finalAmount = type === "æ”¯å‡º" ? -Math.abs(amount) : Math.abs(amount);

            const data = {
                date: document.getElementById('f-date').value,
                typeDir: type,
                project: document.getElementById('f-project').value,
                category: document.getElementById('f-category').value,
                desc: document.getElementById('f-desc').value,
                vendor: type === "æ”¯å‡º" ? document.getElementById('f-vendor').value : "",
                amount: finalAmount
            };

            submitToGoogle('finance', data, btn);
        }

        function submitToGoogle(type, data, btnElement) {
            const originalText = btnElement.innerText;
            btnElement.innerText = "è³‡æ–™å‚³é€ä¸­...";
            btnElement.disabled = true;

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type, data: data })
            })
            .then(() => {
                alert("âœ… è³‡æ–™å·²æˆåŠŸé€å‡ºï¼");
                btnElement.innerText = originalText;
                btnElement.disabled = false;
                if(type === 'worker') {
                    document.getElementById('w-desc').value = "";
                    document.getElementById('w-claim').value = "";
                    document.getElementById('w-claim-desc').value = "";
                } else {
                    document.getElementById('f-amount').value = "";
                    document.getElementById('f-desc').value = "";
                }
            })
            .catch(err => {
                alert("âŒ å‚³é€å¤±æ•—ï¼š" + err);
                btnElement.innerText = originalText;
                btnElement.disabled = false;
            });
        }

        function switchPage(pageName, navElem) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageName).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            navElem.classList.add('active');
            
            const title = document.getElementById('header-title');
            if (pageName === 'worker') {
                title.innerText = "å¸«å‚…å›å ±";
                title.style.color = "var(--primary)";
            } else {
                title.innerText = "è¨˜å¸³";
                title.style.color = "var(--finance)";
            }
        }

        function setFinanceType(type) {
            const btnIn = document.getElementById('btn-income');
            const btnOut = document.getElementById('btn-expense');
            const btnSubmit = document.getElementById('f-submit-btn');
            
            if (type === 'out') {
                document.getElementById('f-type').value = "æ”¯å‡º";
                btnOut.className = "toggle-item active-out";
                btnIn.className = "toggle-item";
                btnSubmit.innerText = "ğŸ’¸ ç¢ºèªæ”¯å‡º";
                btnSubmit.style.backgroundColor = "var(--expense)";
                document.getElementById('vendor-group').style.display = 'block';
            } else {
                document.getElementById('f-type').value = "æ”¶å…¥";
                btnIn.className = "toggle-item active-in";
                btnOut.className = "toggle-item";
                btnSubmit.innerText = "ğŸ’° ç¢ºèªæ”¶å…¥";
                btnSubmit.style.backgroundColor = "var(--finance)";
                document.getElementById('vendor-group').style.display = 'none';
            }
        }

        const unitOptions = document.querySelectorAll('#work-unit-group .btn-option');
        unitOptions.forEach(opt => {
            opt.addEventListener('click', function() {
                unitOptions.forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('w-unit').value = this.dataset.val;
            });
        });
    </script>
</body>
</html>